
// Backslashes in input, how fun...
const sampleInput = String.raw
`.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....`;

const realInput = String.raw
`\.......................|..-.............../../.......|...............\.\.....|..../.............|............
........................../....../..............................-............-.-..--.........-...........\/...
....\............../...........-...-......|.............................\...............-........-....|.......
......\....|................./.\................/..................../.......................|..\......-......
.................../..................-./.................../.....-...................|......\.......|\...\./.
.....|........../....................\../..\.../.\.......-.............\...........\......|.\..-..........-...
..../............/.....\...................../..--\........|......\....-...|.-...../......-........../........
..............\.-............./........./....|\.......\..........|.................|.|.................-......
.....|..........-................-.../..........-........................\.......|.........................-..
.|.-......./....................\........-.............../..\.|.-\...........\./.................-............
................|/............................../..-.\..................-..../../...../.../..../..........|...
........................./.....................\..\....-....../-.....................\|.........././.-........
...\.....................-...../|............--......-..|...../.....|......|.../.\....|.............\|.......\
.........-...-.....|.........../...-/........|......./|............-.......-.....\.............\|....../......
.....|...|.................|...../.............|.................../..........\|..\......|..|....-............
...........................-.........\......\.............\...................-.....-.\.......-.....|.........
.................-.............-......./.............-..\./......|....-..-..........-....-............\.......
.\..\.......-......|........................\.............-.......................|.........|\.|..\......--/..
..........-.....||--........|........-....../...........|../...-.........../.....-.\..........|.......-.......
..........\..........|..................\.................-..../............/..........|.......-........../...
..--......../..........-..|........./.........-...../........-.................|..\............../.....-......
.....\.............|...../......../............./||..........................\............|...................
..-.................-|..-....................\.................|...\.....\............./......-.......\.......
............-../......\...../.-....-.....-....-./../......\..|..|............................|.../..|.........
-................./................................................|...............|....|.....-.....|....../..
...........-...................|...........\.......-..\.......-...........|..-....../........|...............|
.........|...|-........../...-..........|.........\.....||......./....|...............\......-......\...../...
....|.........|............\.-.......................................-.......................|.-..|.\...\.-...
.|....|....-/....................\\..........................|........\|...|..............\..|......-.\../....
..|.\......|..../.....|.......-....................|.\..\............/......................|.....\../../.....
.......|\\.\/......................./.............|................../.........|.....\-.......................
......................................../.../................\-..............-................./......\.......
............../............/\......./........................./......|............\/..........................
......./................|......../.........-............\.../.|....../....|...../..../......../...............
...................|............-\........../...\.......\....\.....-.........-./....|.........................
.....-..-\.................|\...........................|..........\........-...|.............................
..............................-.............-.......\......................../.......\|.......|...-....-......
\...................\..../.................\................|......-...-............./.-......................
........................./.|./...|..\.-............|.-.....-..........\....-..../.....|.......|...............
.................../......../..................|.|...............|.......|\.....|......|...............\/..|..
.........|....-......../........-./..|.../..|./...................-........|..................................
..|../............-......-.........................-..|....-................-..\....../...........|...........
....................-...............|.../.....|..../......../...|.......\.....-.....\..............-..\.-.....
...........\.........../............................................\......-................-.......|.....-...
..-............./.......-\...........|-..-../............../................................../...............
.................\.......\............../.|.......-...\............................................\.-........
.\....|....\......|........./.....--......................................|................\..|-..............
......../...............-..........................|...........................-.............-\.-..|..........
.......|......|/...\........./......../.....\.........\.......................-...........\..\................
.-..-../.............|................./../.................\........-......|.\.....||...................\|...
/......../....\.....|-..........\..............-.....|............/\......\...//....................\...-/....
................-...........-.-\-..........\.-./......../-................./../.\........................./...
-.........-.....|.....-..|..|.........|...................-..........\/.-.....................................
......./...../......\............-.|...............|..../.........|....\.................../..............|...
...........|.......|....|...............\........................\/..\......................................\.
......\........-.........................\..........\.............\......................\/.....\..|..........
......\...........|.........../..-............./........................../...-......../...............\..|...
..|............\../........../............\...|.......................-...............\-../.|...|\.....\......
.|....\.|....-|.........\......./.................../.|........|....../.--.\.....\..............-\\.........-.
......................./.......\...........|.\............-.....\.............\.........--......../.\..-.|../.
......../.............../......\.\....|.............../...........................-........-......../.........
.......|\.............|.../|/........../....\.....-....|.............-......./........\..\........\..|......-.
.............../...........-.....\..\....-...../...|......\...........................\...|...........|/......
.............|....../.................../..|.....................|.......|....//..............\...............
......./....\............................-.........................-/......../|......-....|.............../...
...........................|...................\...............................-.................|...........\
.............................-......./..../...................\.../...........-.|......................||.....
\....\....\...-./......../.........\................./................\...................|...........-.......
................-.../............/\..................\.\..-....../................./..........|...............
......../...\.......................\.......\..\......|.....|../..........\..........-.............|..........
../.........................................-\..........-.........|-./.....-...|..|.......\........-...../../.
.....|..........-......../|-..............|.................-...........|...\.....................\...........
.......|..............\....\.....-............../..\\..\.......-........./.........-..|...|................../
..........-.......-.-................../.........\\...../.....|..........\......./.|.............-...........\
..................................-..................|...........\../\...../..../...\................/........
...-.........................................................\.|..............\..................\............
-.|..|...................../../.|.......\.....|.....\.\...\.........-.................................../.....
...\./....../........\.......-.................\.........|............-.........../...........\.|.........|.\.
..........-...\.............-.-............-.-................/.....................|........|............-...
|......./............/..|..............\...............|.......|\................/....|.........|.........\..\
.....\../\./.....................-.............\..................|.|.........................................
............/......../.../.......\............/.........................\........................\............
....../..|.............../....................-.......\................................................|.....\
................................../.......././.......\.....|.\......-.........-..||......../........-.//......
........................\.......|............-....-...../..............................-............-....|...-
.....-.......|......\..|.........-....|......\......../..../.......\..........|....\.............||..\........
..........|...........-|.......\.......-....../...../..........||.......................\............-..|.....
.................../../..............................|....|................/........|-....|................/..
.....................\................/............................/-........./...|.............\...|..|\.....
.....\..\..........\......../......|.........-....-..-..|...........\....|./....\.\..\............../.........
.......-...............-....../...........-.......................|../...............|...|.........../..../...
.............|.../..................\..\..........-........||................\/...........-|..................
.............-..............-\.../.................|......\...../..........\...-.....-....../................\
.....-....................................-.........\/............../.............................|...........
./.|../......\\..........................................|..............\|/..-\..........................\....
...........-.........\............./....-........-....-....-.........\..\....-\...-...............--.........-
..\.............................\............................./\..........-.............-...-./........../....
.................../........\....|..-....|||./..............-......-./....................../..|...|..........
......\.........../............|\...|.-................../....................|\..|..\.............-./......|.
...........-...................-.|........................\...............|/..-...\...|/\...........|.........
............|..../..................................\.......................\........................-........
.\..........................|......|......../.|....................../.......\......\.............../.........
..........-.../............/..........................|....-......................|.-................|.-......
......../............-...|.....|......../-.....-|...|./.......-..................-\...........................
...............\.\/.-....././................-.../..../.............../-|.....-.......|......./..--...........
..........-\\.|-................./../..|.-.....--................../.................../.|.......-............
..\.................-..............-...............\.....|......................./..\.....--........./..../..\
.......-....../..............|..................\....|..|..........-.....|.|.-.........................\......
..../..\...\....................................||.|......................................|.......\/.........-
................\-.-.....||....\.........................-...................................................|`;

function parseMap(input) {
  return input.split("\n").map((row) => {
    return Array.from(row).map((symbol) => {
      return { symbol, visitedFrom: [] };
    });
  });
}

function add(vec1, vec2) {
  return {
    x: vec1.x + vec2.x,
    y: vec1.y + vec2.y,
  };
}

function tracePath(map, pos, dir, beamGeneration = 0) {
  while (true) {
    const row = map[pos.y];
    const tile = row ? row[pos.x] : undefined;
    if (!tile || undefined !== tile.visitedFrom.find((v) => v.x === dir.x && v.y === dir.y))
      return;
    
    tile.hot = true;
    tile.visitedFrom.push({ ...dir });

    // console.log(`${beamGeneration} ${tile.symbol} p=(${pos.x},${pos.y}) d=(${dir.x},${dir.y})`);
    switch (tile.symbol) {
      case ".":
        pos = add(pos, dir);
        break;
      case "\\":
      case "/":
        const tmp = dir.x;
        dir.x = dir.y;
        dir.y = tmp;
        if ("/" === tile.symbol) {
          dir.x *= -1;
          dir.y *= -1;
        }

        pos = add(pos, dir);
        break;
      case "-": {
        if (dir.x !== 0) {
          pos = add(pos, dir);
          break;
        }

        const dir0 = { y: 0, x: -1 };
        const dir1 = { y: 0, x: 1 };
        tracePath(map, add(pos, dir0), dir0, beamGeneration + 1);
        tracePath(map, add(pos, dir1), dir1, beamGeneration + 1);
        return;
      }
      case "|": {
        if (dir.y !== 0) {
          pos = add(pos, dir);
          break;
        }

        const dir0 = { x: 0, y: -1 };
        const dir1 = { x: 0, y: 1 };
        tracePath(map, add(pos, dir0), dir0, beamGeneration + 1);
        tracePath(map, add(pos, dir1), dir1, beamGeneration + 1);
        return;
      }
      default:
        throw new Error(`Unexpected symbol ${tile.symbol}`);
    }
  }
}

function prettify(map) {
  return map.map((row) => row.map((tile) => tile.hot ? "#" : tile.symbol).join("")).join("\n");
}

function countEnergized(map, pos, dir) {
  tracePath(map, pos, dir);
  console.log(prettify(map));
  const numHot = map.map((row) => row.reduce((accum, tile) => accum + (tile.hot ? 1 : 0), 0)).reduce((accum, rowSum) => accum + rowSum, 0);
  map.forEach((row) => row.forEach((tile) => { tile.hot = false; tile.visitedFrom.length = 0; }));
  return numHot;
}

function part1(input) {
  const map = parseMap(input);
  return countEnergized(map, {x: 0, y: 0}, {x: 1, y: 0});
}

function part2(input) {
  const map = parseMap(input);
  if (map.length !== map[0].length)
    throw new Error("Expected a square map");

  const edge = map.length - 1;
  let maxHot = 0;
  for (let i = 0; i < map.length; i++) {
    maxHot = Math.max(
      maxHot,
      countEnergized(map, {x: 0, y: i}, {x: 1, y: 0}),
      countEnergized(map, {x: edge, y: i}, {x: -1, y: 0}),
      countEnergized(map, {x: i, y: 0}, {x: 0, y: 1}),
      countEnergized(map, {x:i, y: edge}, {x: 0, y: -1})
    );
  }

  return maxHot;
}

console.log(part1(sampleInput));
console.log(part1(realInput));
console.log(part2(sampleInput));
console.log(part2(realInput));
